import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from utils.shap_utils import (
    get_sample_data, 
    get_feature_display_names,
    get_feature_descriptions,
    calculate_shap_values,
    create_shap_force_plot,
    create_contribution_plot
)

# é¡µé¢è®¾ç½®
st.set_page_config(
    page_title="è¡°å¼±é£é™©SHAPåˆ†æ",
    page_icon="ğŸ¥",
    layout="wide",
    initial_sidebar_state="expanded"
)

# è‡ªå®šä¹‰æ ·å¼
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 2rem;
    }
    .risk-high {
        color: #ff4b4b;
        font-weight: bold;
    }
    .risk-medium {
        color: #ffa500;
        font-weight: bold;
    }
    .risk-low {
        color: #00cc96;
        font-weight: bold;
    }
    .feature-card {
        background-color: #f0f2f6;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
    }
</style>
""", unsafe_allow_html=True)

def main():
    # æ ‡é¢˜
    st.markdown('<h1 class="main-header">ğŸ¥ è¡°å¼±é£é™©é¢„æµ‹SHAPåˆ†æ</h1>', unsafe_allow_html=True)
    
    # ä¾§è¾¹æ  - å‚æ•°è¾“å…¥
    st.sidebar.header("ğŸ“Š æ‚£è€…ç‰¹å¾è¾“å…¥")
    
    # è·å–ç‰¹å¾æè¿°
    feature_descriptions = get_feature_descriptions()
    sample_data = get_sample_data()
    feature_display_names = get_feature_display_names()
    
    # åˆ›å»ºä¸¤åˆ—å¸ƒå±€è¾“å…¥
    col1, col2 = st.sidebar.columns(2)
    
    user_input = {}
    with col1:
        user_input['age'] = st.number_input("å¹´é¾„", min_value=0, max_value=120, value=sample_data['age'])
        user_input['gender'] = st.selectbox("æ€§åˆ«", options=[0, 1], format_func=lambda x: "ç”·" if x == 0 else "å¥³", index=sample_data['gender'])
        user_input['bmi'] = st.number_input("BMI", min_value=10.0, max_value=50.0, value=float(sample_data['bmi']), step=0.1)
        user_input['FTSST'] = st.selectbox("FTSST", options=[0, 1], format_func=lambda x: "<12s" if x == 0 else "â‰¥12s", index=sample_data['FTSST'])
        user_input['Complications'] = st.selectbox("å¹¶å‘ç—‡", options=[0, 1, 2], format_func=lambda x: ["æ— ", "1ä¸ª", "â‰¥2ä¸ª"][x], index=sample_data['Complications'])
        user_input['fall'] = st.selectbox("è·Œå€’å²", options=[0, 1], format_func=lambda x: "å¦" if x == 0 else "æ˜¯", index=sample_data['fall'])
    
    with col2:
        user_input['ADL'] = st.selectbox("ADL", options=[0, 1], format_func=lambda x: "æ— é™åˆ¶" if x == 0 else "æœ‰é™åˆ¶", index=sample_data['ADL'])
        user_input['PA'] = st.selectbox("ä½“åŠ›æ´»åŠ¨", options=[0, 1, 2], format_func=lambda x: ["é«˜", "ä¸­", "ä½"][x], index=sample_data['PA'])
        user_input['smoke'] = st.selectbox("å¸çƒŸ", options=[0, 1], format_func=lambda x: "å¦" if x == 0 else "æ˜¯", index=sample_data['smoke'])
        user_input['bl_crp'] = st.number_input("CRP", min_value=0.0, max_value=50.0, value=float(sample_data['bl_crp']), step=0.1)
        user_input['bl_hgb'] = st.number_input("HGB", min_value=50.0, max_value=200.0, value=float(sample_data['bl_hgb']), step=1.0)
    
    # åˆ†ææŒ‰é’®
    analyze_clicked = st.sidebar.button("ğŸš€ å¼€å§‹åˆ†æ", type="primary")
    
    # ä¸»å†…å®¹åŒºåŸŸ
    if analyze_clicked:
        # è®¡ç®—SHAPå€¼
        base_value, current_value, shap_values, features = calculate_shap_values(user_input)
        
        # åˆ›å»ºç‰¹å¾æ˜¾ç¤ºåç§°
        feature_display = []
        for feat in features:
            display_name = feature_display_names[feat]
            value = user_input[feat]
            feature_display.append(f"{display_name} = {value}")
        
        # ç»“æœæ˜¾ç¤º
        st.header("ğŸ“ˆ åˆ†æç»“æœ")
        
        # é£é™©æ°´å¹³è¯„ä¼°
        risk_level = "é«˜é£é™©" if current_value > 0.4 else "ä¸­é£é™©" if current_value > 0.3 else "ä½é£é™©"
        risk_color = "risk-high" if risk_level == "é«˜é£é™©" else "risk-medium" if risk_level == "ä¸­é£é™©" else "risk-low"
        
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("åŸºå‡†é£é™©", f"{base_value:.1%}")
        with col2:
            st.metric("é¢„æµ‹é£é™©", f"{current_value:.1%}")
        with col3:
            st.metric("é£é™©ç­‰çº§", f"{risk_level}", delta=None)
        
        # SHAPåŠ›å›¾
        st.subheader("ğŸ” SHAPåŠ›å›¾åˆ†æ")
        st.write("ä¸‹å›¾æ˜¾ç¤ºäº†å„ç‰¹å¾å¯¹é¢„æµ‹ç»“æœçš„è´¡çŒ®ç¨‹åº¦ï¼š")
        
        fig1 = create_shap_force_plot(base_value, shap_values, feature_display)
        st.pyplot(fig1)
        
        # è´¡çŒ®åº¦æ’åºå›¾
        st.subheader("ğŸ“Š ç‰¹å¾è´¡çŒ®åº¦æ’åº")
        fig2 = create_contribution_plot(user_input, feature_display_names, shap_values)
        st.pyplot(fig2)
        
        # è¯¦ç»†åˆ†æ
        st.subheader("ğŸ“‹ è¯¦ç»†ç‰¹å¾åˆ†æ")
        
        # é£é™©å› ç´ æ€»ç»“
        positive_features = []
        negative_features = []
        
        for i, feat in enumerate(features):
            if shap_values[i] > 0:
                positive_features.append((feature_display_names[feat], user_input[feat], shap_values[i]))
            else:
                negative_features.append((feature_display_names[feat], user_input[feat], shap_values[i]))
        
        # æŒ‰è´¡çŒ®åº¦æ’åº
        positive_features.sort(key=lambda x: x[2], reverse=True)
        negative_features.sort(key=lambda x: x[2])
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.write("**ğŸ”¼ å¢åŠ é£é™©çš„å› ç´ :**")
            for feat, value, shap_val in positive_features:
                st.write(f"- {feat} = {value}: +{shap_val:.3f}")
        
        with col2:
            st.write("**ğŸ”½ é™ä½é£é™©çš„å› ç´ :**")
            for feat, value, shap_val in negative_features:
                st.write(f"- {feat} = {value}: {shap_val:.3f}")
        
        # ç‰¹å¾è¯´æ˜
        st.subheader("â„¹ï¸ ç‰¹å¾è¯´æ˜")
        for feat, desc in feature_descriptions.items():
            with st.expander(f"{feature_display_names[feat]}: {desc['description']}"):
                st.write(f"**å–å€¼è¯´æ˜:** {desc['values']}")
                st.write(f"**å½“å‰å€¼:** {user_input[feat]}")
    
    else:
        # é»˜è®¤æ˜¾ç¤ºè¯´æ˜
        st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§è¾“å…¥æ‚£è€…ç‰¹å¾å‚æ•°ï¼Œç„¶åç‚¹å‡»'å¼€å§‹åˆ†æ'æŒ‰é’®")
        
        # æ˜¾ç¤ºé»˜è®¤æ•°æ®é¢„è§ˆ
        st.subheader("ğŸ“ é»˜è®¤æ ·æœ¬æ•°æ®é¢„è§ˆ")
        display_df = pd.DataFrame([get_sample_data()])
        display_df = display_df.rename(columns=get_feature_display_names())
        st.dataframe(display_df, use_container_width=True)
        
        # ç‰¹å¾è¯´æ˜
        st.subheader("ğŸ“‹ ç‰¹å¾è¯´æ˜")
        for feat, desc in feature_descriptions.items():
            st.write(f"**{feature_display_names[feat]}**: {desc['description']} - {desc['values']}")

if __name__ == "__main__":
    main()